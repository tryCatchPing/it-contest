name: Flutter CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

env:
  FLUTTER_VERSION: "3.32.5"
  JAVA_VERSION: "11"

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true # â† Flutter SDK ì¬ì‚¬ìš©ìœ¼ë¡œ ~2ë¶„ ì ˆì•½

      - name: Get dependencies
        run: flutter pub get

      - name: Verify pub get
        run: flutter pub deps

      - name: Run code analysis
        run: flutter analyze --no-fatal-infos

  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: analyze
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        # ì„ì‹œë¡œ Android ë¹Œë“œ ë¹„í™œì„±í™” - CI í™˜ê²½ì˜ ë³µì¡í•œ Android SDK/NDK ì„¤ì • ë¬¸ì œë¡œ ì¸í•¨
        # ì›¹ ë¹Œë“œì™€ ì½”ë“œ ë¶„ì„ì„ í†µí•´ ê¸°ë³¸ì ì¸ í’ˆì§ˆ ê²€ì¦ì€ ìœ ì§€
        # Android ë¹Œë“œëŠ” ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ê²€ì¦ í›„ ì¶”í›„ CI ì¬í™œì„±í™” ì˜ˆì •
        build-target: [web] # android ì„ì‹œ ì œì™¸

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
          cache: true

      # ì›¹ ì „ìš©ìœ¼ë¡œ ê°„ì†Œí™”ëœ ì˜ì¡´ì„± ìºì‹±
      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ runner.tool_cache }}/flutter
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-
            ${{ runner.os }}-flutter-

      - name: Get dependencies
        run: |
          flutter pub get
          flutter pub deps

          # ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
          echo "Checking installed packages..."
          flutter pub deps | grep -E "(pdfx|file_picker)" || echo "PDF packages not found (expected for non-PDF branches)"

      # PDF.js ì„¤ì • (ì›¹ ì „ìš©)
      - name: Setup PDF.js for web
        run: |
          echo "Checking PDF.js configuration..."

          # web/index.htmlì´ ì´ë¯¸ PDF.jsë¥¼ í¬í•¨í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
          if [ -f "web/index.html" ] && grep -q "pdfjs-dist" web/index.html; then
            echo "âœ… PDF.js already configured, skipping installation"
          else
            echo "ğŸ“¦ Installing PDF.js for web..."

            # pdfx íŒ¨í‚¤ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
            if flutter pub deps | grep -q "pdfx"; then
              flutter pub run pdfx:install_web
              echo "âœ… PDF.js setup completed"
            else
              echo "âš ï¸ pdfx package not found, skipping PDF.js installation"
              echo "This is expected for branches without PDF functionality"
            fi
          fi

      - name: Verify web configuration
        run: |
          if [ -f "web/index.html" ]; then
            echo "âœ… web/index.html exists"

            # PDF.js ì„¤ì • í™•ì¸ (ì„ íƒì )
            if grep -q "pdfjs-dist" web/index.html; then
              echo "âœ… PDF.js scripts found in web/index.html"
            else
              echo "â„¹ï¸ PDF.js scripts not found - this is normal for non-PDF branches"
            fi
          else
            echo "âŒ web/index.html not found"
            exit 1
          fi

      - name: Build Web Application
        run: |
          echo "Building web application..."
          flutter build web --release
          echo "âœ… Web build completed successfully"

      - name: Verify web build output
        run: |
          if [ -d "build/web" ]; then
            echo "âœ… Web build output exists"
            echo "Build size information:"
            du -sh build/web
            ls -la build/web/
          else
            echo "âŒ Web build output not found"
            exit 1
          fi

    # Android ë¹Œë“œ (ì„ì‹œ ë¹„í™œì„±í™”)
    #
    # Android CI ë¹Œë“œëŠ” ë³µì¡í•œ SDK/NDK í™˜ê²½ ì„¤ì •ìœ¼ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë¨
    # ê°œë°œìë“¤ì€ ë¡œì»¬ í™˜ê²½ì—ì„œ Android ë¹Œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ê³„ì† ì§„í–‰
    #
    # ì¬í™œì„±í™” ì¡°ê±´:
    # 1. PDF íŒ¨í‚¤ì§€ í†µí•© ì™„ë£Œ
    # 2. Android NDK ë²„ì „ ì¶©ëŒ í•´ê²°
    # 3. CI í™˜ê²½ì—ì„œ ì•ˆì •ì ì¸ Android ë¹Œë“œ í™•ì¸
    #
    # build-android:
    #   name: Build Android (Disabled)
    #   runs-on: ubuntu-latest
    #   needs: analyze
    #   if: false  # ì„ì‹œ ë¹„í™œì„±í™”
    #   steps:
    #     - name: Android build placeholder
    #       run: echo "Android builds temporarily disabled in CI"

  # í…ŒìŠ¤íŠ¸ job (ë¯¸ë˜ ì‚¬ìš©ì„ ìœ„í•´ ì¤€ë¹„)
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   needs: analyze
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: "stable"
  #         cache: true
  #
  #     - name: Get dependencies
  #       run: flutter pub get
  #
  #     - name: Run tests
  #       run: flutter test --coverage
  #
  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v3
  #       with:
  #         file: coverage/lcov.info
